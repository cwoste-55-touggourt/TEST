<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body {
  font-family: Cairo, sans-serif;
  background: #f4f6fb;
  margin: 0;
  padding: 20px;
}

/* ===== Header ===== */
header {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

h2 { color: #0d47a1; margin: 0; }

.stats {
  background: #e3f2fd;
  padding: 10px 16px;
  border-radius: 12px;
  font-weight: bold;
  color: #0d47a1;
}

input.search {
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-family: Cairo;
  width: 260px;
}

button {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-family: Cairo;
  font-weight: 600;
}

.add { background: #1976d2; color: white; }
.edit { background: #ffca28; }
.delete { background: #ef5350; color: white; }

/* ===== Table ===== */
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

th {
  background: #1976d2;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

tr:hover { background: #e3f2fd; }
.actions button { margin: 2px; }

/* ===== Loading Overlay ===== */
#loading {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loader {
  text-align: center;
  color: #1976d2;
  font-weight: bold;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e3f2fd;
  border-top: 6px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<!-- Loading -->
<div id="loading">
  <div class="loader">
    <div class="spinner"></div>
    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
  </div>
</div>

<header>
  <h2>Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
  <div class="stats">ğŸ‘¥ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalCount">0</span></div>
  <input id="searchInput" class="search" placeholder="Ø¨Ø­Ø«...">
  <button class="add" onclick="openForm()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
</header>

<table>
<thead>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</th>
  <th>Ø§Ù„Ø§Ø³Ù…</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø²Ø¯ÙŠØ§Ø¯</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ¸ÙŠÙ</th>
  <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
  <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  setDoc, updateDoc, deleteDoc,
  doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAkQz9pB2ZNlYIvdlTRvi4try3D8LLXS4g",
  authDomain: "databaseemploye.firebaseapp.com",
  projectId: "databaseemploye"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.getElementById("tableBody");
const loading = document.getElementById("loading");
const totalCount = document.getElementById("totalCount");

/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
const showLoading = () => loading.style.display = "flex";
const hideLoading = () => loading.style.display = "none";

function formatDate(value) {
  if (!value) return "";
  if (value.seconds) value = new Date(value.seconds * 1000);
  const d = new Date(value);
  if (isNaN(d)) return value;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
async function loadData() {
  showLoading();
  tbody.innerHTML = "";
  const snap = await getDocs(collection(db, "employeescom"));
  totalCount.textContent = snap.size;

  snap.forEach(docu => {
    const d = docu.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${docu.id}</td>
      <td>${d.name}</td>
      <td>${formatDate(d.diz)}</td>
      <td>${formatDate(d.dtw)}</td>
      <td>${d.grade}</td>
      <td>${d.place}</td>
      <td class="actions">
        <button class="edit" onclick="openForm('${docu.id}')">âœï¸</button>
        <button class="delete" onclick="removeEmp('${docu.id}')">ğŸ—‘ï¸</button>
      </td>`;
    tbody.appendChild(tr);
  });

  hideLoading();
}

loadData();

/* ===== Ø§Ù„Ø¨Ø­Ø« ===== */
document.getElementById("searchInput").addEventListener("keyup", e => {
  const v = e.target.value.toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(v) ? "" : "none";
  });
});

/* ===== Ø§Ø³ØªÙ…Ø§Ø±Ø© ===== */
window.openForm = async (id = null) => {
  let data = { name:"", diz:"", dtw:"", grade:"", place:"" };

  if (id) {
    showLoading();
    const snap = await getDoc(doc(db,"employeescom",id));
    data = snap.data();
    hideLoading();
  }

  const { value } = await Swal.fire({
    title: id ? "ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù" : "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù",
    html: `
      <input id="fid" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ (16 Ø±Ù‚Ù…)" ${id?"disabled":""} value="${id||""}">
      <input id="fname" class="swal2-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" value="${data.name||""}">
      <input id="fdiz" type="date" class="swal2-input" value="${formatDate(data.diz)}">
      <input id="fdtw" type="date" class="swal2-input" value="${formatDate(data.dtw)}">
      <input id="fgrade" class="swal2-input" placeholder="Ø§Ù„Ø±ØªØ¨Ø©" value="${data.grade||""}">
      <input id="fplace" class="swal2-input" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„" value="${data.place||""}">
    `,
    focusConfirm: false,
    preConfirm: async () => {
      const empId = fid.value.trim();
      if (!id && !/^\d{16}$/.test(empId)) {
        Swal.showValidationMessage("Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16 Ø±Ù‚Ù…Ù‹Ø§");
        return false;
      }
      if (!id) {
        const exists = await getDoc(doc(db,"employeescom",empId));
        if (exists.exists()) {
          Swal.showValidationMessage("Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");
          return false;
        }
      }
      return {
        empId,
        name: fname.value,
        diz: fdiz.value,
        dtw: fdtw.value,
        grade: fgrade.value,
        place: fplace.value
      };
    }
  });

  if (!value) return;

  showLoading();

  if (id) {
    await updateDoc(doc(db,"employeescom",id), value);
    Swal.fire("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­","success");
  } else {
    await setDoc(doc(db,"employeescom",value.empId), {
      id: value.empId,
      ...value
    });
    Swal.fire("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©","ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­","success");
  }

  await loadData();
};

/* ===== Ø­Ø°Ù ===== */
window.removeEmp = async (id) => {
  const ok = await Swal.fire({
    icon: "warning",
    title: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
    showCancelButton: true,
    confirmButtonText: "Ø­Ø°Ù",
    cancelButtonText: "Ø¥Ù„ØºØ§Ø¡"
  });

  if (!ok.isConfirmed) return;

  showLoading();
  await deleteDoc(doc(db,"employeescom",id));
  Swal.fire("ØªÙ… Ø§Ù„Ø­Ø°Ù","ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­","success");
  await loadData();
};
</script>

</body>
</html>
