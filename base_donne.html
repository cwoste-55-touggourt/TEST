<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ظ‚ط§ط¹ط¯ط© ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ظˆط¸ظپظٹظ†</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: Cairo;
  background: #f4f6fb;
  margin: 0;
  padding: 20px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

h2 { color: #0d47a1; margin: 0; }

input {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-family: Cairo;
}

button {
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-family: Cairo;
}

.add-btn { background: #1976d2; color: white; }
.back-btn { background: #607d8b; color: white; }

.stats {
  margin: 15px 0;
  font-weight: bold;
  color: #333;
}

table {
  width: 100%;
  background: white;
  border-collapse: collapse;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

th {
  background: #1976d2;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

tr:hover { background: #e3f2fd; }

.actions button {
  margin: 2px;
  font-size: 14px;
}

.edit { background: #ffca28; }
.delete { background: #ef5350; color: white; }
.hidden-row { display: none !important; }

#loading {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e3f2fd;
  border-top: 6px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div id="loading"><div class="spinner"></div></div>

<header>
  <h2>ًں“‚ ظ‚ط§ط¹ط¯ط© ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ظˆط¸ظپظٹظ†</h2>
  <input id="search" placeholder="ًں”چ ط¨ط­ط«">
  <button class="add-btn" onclick="openForm()">â‍• ط¥ط¶ط§ظپط© ظ…ظˆط¸ظپ</button>
  <button class="back-btn" onclick="history.back()">â¬…ï¸ڈ ط±ط¬ظˆط¹</button>
</header>

<div class="stats">ًں‘¥ ط¹ط¯ط¯ ط§ظ„ظ…ظˆط¸ظپظٹظ†: <span id="count">0</span></div>

<table>
<thead>
<tr>
  <th>ط±ظ‚ظ… ط§ظ„طھط¹ط±ظٹظپ</th>
  <th>ط§ظ„ط§ط³ظ…</th>
  <th>طھط§ط±ظٹط® ط§ظ„ط§ط²ط¯ظٹط§ط¯</th>
  <th>طھط§ط±ظٹط® ط§ظ„طھظˆط¸ظٹظپ</th>
  <th>ط§ظ„ط±طھط¨ط©</th>
  <th>ظ…ظƒط§ظ† ط§ظ„ط¹ظ…ظ„</th>
  <th>ط¥ط¬ط±ط§ط،ط§طھ</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ًں”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAkQz9pB2ZNlYIvdlTRvi4try3D8LLXS4g",
  authDomain: "databaseemploye.firebaseapp.com",
  projectId: "databaseemploye",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ًںڑ€ Cache */
const CACHE = new Map();
const tbody = document.getElementById("tbody");
const count = document.getElementById("count");
const loading = document.getElementById("loading");
const searchInput = document.getElementById("search");

/* âڈ³ */
/* Loader helpers: always check element exists and keep aria attribute in sync.
  We also ensure the loader is hidden on errors or timeouts so the UI doesn't stay stuck. */
const showLoading = () => { if (loading) { loading.style.display = "flex"; loading.setAttribute('aria-hidden','false'); } };
const hideLoading = () => { if (loading) { loading.style.display = "none"; loading.setAttribute('aria-hidden','true'); } };

/* ًں“… */
// Format date-like values safely for input[type=date] / display.
// Accepts: null/undefined -> "", ISO string, timestamp number, or Firestore Timestamp (has toDate()).
const fmt = v => {
  if (!v && v !== 0) return "";
  try {
    let dt;
    if (typeof v === 'object' && v !== null && typeof v.toDate === 'function') {
      dt = v.toDate();
    } else {
      dt = new Date(v);
    }
    if (!isFinite(dt.getTime())) return "";
    return dt.toISOString().slice(0,10);
  } catch (e) {
    console.warn('fmt: invalid date value', v, e);
    return "";
  }
};

/* ذ¯??? Fast helpers */
const debounce = (fn, delay = 150) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
};

const htmlEscape = v => String(v ?? "")
  .replace(/&/g,"&amp;")
  .replace(/</g,"&lt;")
  .replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;")
  .replace(/'/g,"&#39;");

const rowMarkup = (id, d) => {
  const nm = htmlEscape(d?.name ?? "");
  const gr = htmlEscape(d?.grade ?? "");
  const pl = htmlEscape(d?.place ?? "");
  const diz = htmlEscape(fmt(d?.diz));
  const dtw = htmlEscape(fmt(d?.dtw));
  const safeId = htmlEscape(id);
  const searchKey = htmlEscape(`${id} ${d?.name ?? ""} ${d?.grade ?? ""} ${d?.place ?? ""}`.toLowerCase());
  return `
    <tr data-id="${safeId}" data-search="${searchKey}">
      <td>${safeId}</td>
      <td>${nm}</td>
      <td>${diz}</td>
      <td>${dtw}</td>
      <td>${gr}</td>
      <td>${pl}</td>
      <td class="actions">
        <button class="edit" onclick="openForm('${id}')">â”گ??â–€??</button>
        <button class="delete" onclick="removeEmp('${id}')">ذ¯???â–€??</button>
      </td>
    </tr>`;
};

let rowCache = [];
let currentFilter = "";
let filterRaf = null;
const syncRowCache = () => { rowCache = Array.from(tbody.rows); };

const runFilter = term => {
  currentFilter = term;
  const q = term.trim().toLowerCase();
  if (filterRaf) cancelAnimationFrame(filterRaf);
  if (!rowCache.length) return;
  if (!q) {
    rowCache.forEach(tr => tr.classList.remove('hidden-row'));
    return;
  }
  let i = 0;
  const len = rowCache.length;
  const step = () => {
    const limit = Math.min(i + 250, len);
    for (; i < limit; i++) {
      const tr = rowCache[i];
      const match = (tr.dataset.search || "").includes(q);
      tr.classList.toggle('hidden-row', !match);
    }
    if (i < len) filterRaf = requestAnimationFrame(step);
  };
  filterRaf = requestAnimationFrame(step);
};

const scheduleFilter = debounce(v => runFilter(v), 140);
if (searchInput) {
  searchInput.addEventListener("input", e => scheduleFilter(e.target.value));
}

/* ًںڑ€ Load once */
async function init() {
  showLoading();
  // fail-safe: hide loader after 15s and notify user if still visible
  const loaderTimer = setTimeout(() => {
    if (loading && loading.style.display !== 'none') {
      hideLoading();
      console.error('Loading timeout');
      Swal.fire('ط®ط·ط£','طھط¹ط°ط± طھط­ظ…ظٹظ„ ط§ظ„ط¨ظٹط§ظ†ط§طھ â€” ظٹط±ط¬ظ‰ ط§ظ„طھط­ظ‚ظ‚ ظ…ظ† ط§ظ„ط§طھطµط§ظ„ ط¨ط§ظ„ط¥ظ†طھط±ظ†طھ','error');
    }
  }, 15000);

  try {
    const snap = await getDocs(collection(db, "employeescom"));
    // inspect date-like fields for suspicious values to help debugging
    const isSuspiciousDate = v => {
      if (!v && v !== 0) return false;
      if (typeof v === 'object' && v !== null && typeof v.toDate !== 'function') {
        // Firestore sometimes serializes to plain object with seconds/nanoseconds
        if ('seconds' in v && 'nanoseconds' in v) return true;
      }
      if (typeof v === 'string' && isNaN(Date.parse(v))) return true;
      if (typeof v === 'number' && !isFinite(v)) return true;
      return false;
    };

    snap.forEach(docu => {
      const data = docu.data();
      if (isSuspiciousDate(data.diz) || isSuspiciousDate(data.dtw)) {
        console.warn('Suspicious date in record', docu.id, { diz: data.diz, dtw: data.dtw });
      }
      CACHE.set(docu.id, data);
    });
    renderAll();
  } catch (err) {
    console.error('Failed to load data:', err);
    Swal.fire('ط®ط·ط£','طھط¹ط°ط± طھط­ظ…ظٹظ„ ط§ظ„ط¨ظٹط§ظ†ط§طھ: ' + (err.message || err),'error');
  } finally {
    clearTimeout(loaderTimer);
    hideLoading();
  }
}
init();

// ensure any unexpected promise rejections or errors hide the loader
window.addEventListener('unhandledrejection', e => {
  console.error('Unhandled rejection', e);
  hideLoading();
});
window.addEventListener('error', e => {
  console.error('Global error', e.error || e.message || e);
  hideLoading();
});

/* Render سريع */
function renderAll() {
  const rows = [];
  CACHE.forEach((d,id) => rows.push(rowMarkup(id,d)));
  tbody.innerHTML = rows.join("");
  syncRowCache();
  count.textContent = CACHE.size;
  const activeFilter = searchInput ? searchInput.value : currentFilter;
  runFilter(activeFilter);
}

const upsertRow = (id, data) => {
  const html = rowMarkup(id, data);
  const existing = tbody.querySelector(`tr[data-id="${id}"]`);
  if (existing) {
    existing.outerHTML = html;
  } else {
    tbody.insertAdjacentHTML("beforeend", html);
  }
  syncRowCache();
  count.textContent = CACHE.size;
  runFilter(currentFilter);
};

const removeRowDom = id => {
  const tr = tbody.querySelector(`tr[data-id="${id}"]`);
  if (tr) tr.remove();
  syncRowCache();
  count.textContent = CACHE.size;
  runFilter(currentFilter);
};

/* â‍•âœڈï¸ڈ Form */
window.openForm = (id=null) => {
  const d = id ? CACHE.get(id) : {};
  Swal.fire({
    title: id ? "âœڈï¸ڈ طھط¹ط¯ظٹظ„ ظ…ظˆط¸ظپ" : "â‍• ط¥ط¶ط§ظپط© ظ…ظˆط¸ظپ",
    html: `
      <input id="fid" class="swal2-input" placeholder="ط±ظ‚ظ… ط§ظ„طھط¹ط±ظٹظپ (16 ط±ظ‚ظ…)" value="${id||""}" ${id?"disabled":""}>
      <input id="fname" class="swal2-input" placeholder="ط§ظ„ط§ط³ظ…" value="${d.name||""}">
      <input id="fdiz" type="date" class="swal2-input" value="${fmt(d.diz)}">
      <input id="fdtw" type="date" class="swal2-input" value="${fmt(d.dtw)}">
      <input id="fgrade" class="swal2-input" placeholder="ط§ظ„ط±طھط¨ط©" value="${d.grade||""}">
      <input id="fplace" class="swal2-input" placeholder="ظ…ظƒط§ظ† ط§ظ„ط¹ظ…ظ„" value="${d.place||""}">
    `,
      preConfirm: async () => {
      const fid = document.getElementById("fid").value;
      const fnameEl = document.getElementById("fname");
      const fdizEl = document.getElementById("fdiz");
      const fdtwEl = document.getElementById("fdtw");
      const fgradeEl = document.getElementById("fgrade");
      const fplaceEl = document.getElementById("fplace");

      if (!/^\d{16}$/.test(fid)) return Swal.showValidationMessage("ط±ظ‚ظ… ط§ظ„طھط¹ط±ظٹظپ ظٹط¬ط¨ 16 ط±ظ‚ظ…");

      if (!id && CACHE.has(fid)) return Swal.showValidationMessage("âڑ ï¸ڈ ط±ظ‚ظ… ظ…ظˆط¬ظˆط¯");

      const data = {
        id: fid,
        name: fnameEl ? fnameEl.value : "",
        diz: fdizEl ? fdizEl.value : "",
        dtw: fdtwEl ? fdtwEl.value : "",
        grade: fgradeEl ? fgradeEl.value : "",
        place: fplaceEl ? fplaceEl.value : ""
      };

      showLoading();
      try {
        if (id) {
          await updateDoc(doc(db,"employeescom",id),data);
        } else {
          await setDoc(doc(db,"employeescom",fid),data);
        }
        CACHE.set(fid,data);
        upsertRow(fid,data);
        Swal.fire("âœ… طھظ… ط§ظ„ط­ظپط¸","طھظ…طھ ط§ظ„ط¹ظ…ظ„ظٹط© ط¨ظ†ط¬ط§ط­","success");
      } catch (err) {
        console.error('Save error', err);
        Swal.showValidationMessage('ط­ط¯ط« ط®ط·ط£ ط£ط«ظ†ط§ط، ط§ظ„ط­ظپط¸: ' + (err.message || err));
      } finally {
        hideLoading();
      }
    }
  });
};

/* ًں—‘ï¸ڈ Delete */
window.removeEmp = async id => {
  if (!await Swal.fire({title:"ط­ط°ظپطں",icon:"warning",showCancelButton:true}).then(r=>r.isConfirmed)) return;
  showLoading();
  try {
    await deleteDoc(doc(db,"employeescom",id));
    CACHE.delete(id);
    removeRowDom(id);
    Swal.fire("ًں—‘ï¸ڈ طھظ… ط§ظ„ط­ط°ظپ","طھظ… ط­ط°ظپ ط§ظ„ظ…ظˆط¸ظپ","success");
  } catch (err) {
    console.error('Delete error', err);
    Swal.fire('ط®ط·ط£','ط­ط¯ط« ط®ط·ط£ ط£ط«ظ†ط§ط، ط§ظ„ط­ط°ظپ: ' + (err.message || err),'error');
  } finally {
    hideLoading();
  }
};
</script>

</body>
</html>


