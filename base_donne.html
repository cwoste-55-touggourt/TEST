<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: Cairo;
  background: #f4f6fb;
  margin: 0;
  padding: 20px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

h2 { color: #0d47a1; margin: 0; }

input {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-family: Cairo;
}

button {
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-family: Cairo;
}

.add-btn { background: #1976d2; color: white; }
.back-btn { background: #607d8b; color: white; }

.stats {
  margin: 15px 0;
  font-weight: bold;
  color: #333;
}

table {
  width: 100%;
  background: white;
  border-collapse: collapse;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

th {
  background: #1976d2;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

tr:hover { background: #e3f2fd; }

.actions button {
  margin: 2px;
  font-size: 14px;
}

.edit { background: #ffca28; }
.delete { background: #ef5350; color: white; }

#loading {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e3f2fd;
  border-top: 6px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div id="loading"><div class="spinner"></div></div>

<header>
  <h2>ğŸ“‚ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
  <input id="search" placeholder="ğŸ” Ø¨Ø­Ø«">
  <button class="add-btn" onclick="openForm()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
  <button class="back-btn" onclick="history.back()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</header>

<div class="stats">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: <span id="count">0</span></div>

<table>
<thead>
<tr>
  <th>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</th>
  <th>Ø§Ù„Ø§Ø³Ù…</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø²Ø¯ÙŠØ§Ø¯</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ¸ÙŠÙ</th>
  <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
  <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ğŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAkQz9pB2ZNlYIvdlTRvi4try3D8LLXS4g",
  authDomain: "databaseemploye.firebaseapp.com",
  projectId: "databaseemploye",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ğŸš€ Cache */
const CACHE = new Map();
const tbody = document.getElementById("tbody");
const count = document.getElementById("count");
const loading = document.getElementById("loading");

/* â³ */
const showLoading = () => loading.style.display = "flex";
const hideLoading = () => loading.style.display = "none";

/* ğŸ“… */
const fmt = d => d ? new Date(d).toISOString().slice(0,10) : "";

/* ğŸš€ Load once */
showLoading();
const snap = await getDocs(collection(db, "employeescom"));
snap.forEach(docu => CACHE.set(docu.id, docu.data()));
render();
hideLoading();

/* ğŸ§± Render */
function render() {
  const frag = document.createDocumentFragment();
  tbody.innerHTML = "";

  CACHE.forEach((d,id) => {
    const tr = document.createElement("tr");
    tr.dataset.search = `${id} ${d.name} ${d.grade} ${d.place}`.toLowerCase();
    tr.innerHTML = `
      <td>${id}</td>
      <td>${d.name}</td>
      <td>${fmt(d.diz)}</td>
      <td>${fmt(d.dtw)}</td>
      <td>${d.grade}</td>
      <td>${d.place}</td>
      <td class="actions">
        <button class="edit" onclick="openForm('${id}')">âœï¸</button>
        <button class="delete" onclick="removeEmp('${id}')">ğŸ—‘ï¸</button>
      </td>`;
    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
  count.textContent = CACHE.size;
}

/* ğŸ” Search */
document.getElementById("search").oninput = e => {
  const v = e.target.value.toLowerCase();
  tbody.querySelectorAll("tr").forEach(tr => {
    tr.style.display = tr.dataset.search.includes(v) ? "" : "none";
  });
};

/* â•âœï¸ Form */
window.openForm = (id=null) => {
  const d = id ? CACHE.get(id) : {};
  Swal.fire({
    title: id ? "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù" : "â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù",
    html: `
      <input id="fid" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ (16 Ø±Ù‚Ù…)" value="${id||""}" ${id?"disabled":""}>
      <input id="fname" class="swal2-input" placeholder="Ø§Ù„Ø§Ø³Ù…" value="${d.name||""}">
      <input id="fdiz" type="date" class="swal2-input" value="${fmt(d.diz)}">
      <input id="fdtw" type="date" class="swal2-input" value="${fmt(d.dtw)}">
      <input id="fgrade" class="swal2-input" placeholder="Ø§Ù„Ø±ØªØ¨Ø©" value="${d.grade||""}">
      <input id="fplace" class="swal2-input" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„" value="${d.place||""}">
    `,
    preConfirm: async () => {
      const fid = document.getElementById("fid").value;
      if (!/^\d{16}$/.test(fid)) return Swal.showValidationMessage("Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙŠØ¬Ø¨ 16 Ø±Ù‚Ù…");

      if (!id && CACHE.has(fid)) return Swal.showValidationMessage("âš ï¸ Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯");

      const data = {
        id: fid,
        name: fname.value,
        diz: fdiz.value,
        dtw: fdtw.value,
        grade: fgrade.value,
        place: fplace.value
      };

      showLoading();
      id ? await updateDoc(doc(db,"employeescom",id),data)
         : await setDoc(doc(db,"employeescom",fid),data);

      CACHE.set(fid,data);
      render();
      hideLoading();
      Swal.fire("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸","ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­","success");
    }
  });
};

/* ğŸ—‘ï¸ Delete */
window.removeEmp = async id => {
  if (!await Swal.fire({title:"Ø­Ø°ÙØŸ",icon:"warning",showCancelButton:true}).then(r=>r.isConfirmed)) return;
  showLoading();
  await deleteDoc(doc(db,"employeescom",id));
  CACHE.delete(id);
  render();
  hideLoading();
  Swal.fire("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù","ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù","success");
};
</script>

</body>
</html>
